USE LibraryDB;

CREATE TABLE Publisher (
    PublisherID INT AUTO_INCREMENT PRIMARY KEY,
    Name VARCHAR(100) NOT NULL,
    Address VARCHAR(255),
    ContactNumber VARCHAR(50),
    Email VARCHAR(100)
);

CREATE TABLE Category (
    CategoryID INT AUTO_INCREMENT PRIMARY KEY,
    Name VARCHAR(100) NOT NULL UNIQUE,
    Description VARCHAR(255)
);

CREATE TABLE Book (
    BookID INT AUTO_INCREMENT PRIMARY KEY,
    Title VARCHAR(200) NOT NULL,
    ISBN VARCHAR(20) UNIQUE,
    Edition VARCHAR(50),
    PublishYear YEAR,
    PublisherID INT NOT NULL,
    CategoryID INT NOT NULL,
    FOREIGN KEY (PublisherID) REFERENCES Publisher(PublisherID)
        ON DELETE RESTRICT ON UPDATE CASCADE,
    FOREIGN KEY (CategoryID) REFERENCES Category(CategoryID)
        ON DELETE RESTRICT ON UPDATE CASCADE
);

CREATE TABLE Author (
    AuthorID INT AUTO_INCREMENT PRIMARY KEY,
    FirstName VARCHAR(100),
    LastName VARCHAR(100),
    Biography TEXT,
    Email VARCHAR(100) UNIQUE
);

CREATE TABLE BookAuthor (
    BookID INT,
    AuthorID INT,
    PRIMARY KEY (BookID, AuthorID),
    FOREIGN KEY (BookID) REFERENCES Book(BookID)
        ON DELETE CASCADE ON UPDATE CASCADE,
    FOREIGN KEY (AuthorID) REFERENCES Author(AuthorID)
        ON DELETE CASCADE ON UPDATE CASCADE
);

CREATE TABLE Copy (
    CopyID INT AUTO_INCREMENT PRIMARY KEY,
    BookID INT NOT NULL,
    Barcode VARCHAR(50) UNIQUE NOT NULL,
    Location VARCHAR(100),
    Condition ENUM('New','Good','Damaged') DEFAULT 'Good',
    Status ENUM('Available','Loaned','Lost') DEFAULT 'Available',
    FOREIGN KEY (BookID) REFERENCES Book(BookID)
        ON DELETE RESTRICT ON UPDATE CASCADE
);

CREATE TABLE Member (
    MemberID INT AUTO_INCREMENT PRIMARY KEY,
    FullName VARCHAR(200) NOT NULL,
    DateOfBirth DATE,
    Address VARCHAR(255),
    Phone VARCHAR(50),
    Email VARCHAR(100) UNIQUE,
    JoinDate DATE DEFAULT CURRENT_DATE,
    MembershipType ENUM('Regular','Premium') DEFAULT 'Regular',
    Status ENUM('Active','Blocked') DEFAULT 'Active'
);

CREATE TABLE Staff (
    StaffID INT AUTO_INCREMENT PRIMARY KEY,
    FullName VARCHAR(200),
    Role ENUM('Librarian','Assistant','Admin') DEFAULT 'Assistant',
    Username VARCHAR(100) UNIQUE,
    Password VARCHAR(255) NOT NULL,
    ContactNumber VARCHAR(50),
    Email VARCHAR(100) UNIQUE
);

CREATE TABLE Loan (
    LoanID INT AUTO_INCREMENT PRIMARY KEY,
    CopyID INT,
    MemberID INT,
    StaffID_Issued INT,
    IssueDate DATE NOT NULL,
    DueDate DATE NOT NULL,
    ReturnDate DATE,
    FineAmount DECIMAL(10,2) DEFAULT 0,
    Status ENUM('Active','Returned','Overdue') DEFAULT 'Active',
    FOREIGN KEY (CopyID) REFERENCES Copy(CopyID)
        ON DELETE RESTRICT ON UPDATE CASCADE,
    FOREIGN KEY (MemberID) REFERENCES Member(MemberID)
        ON DELETE RESTRICT ON UPDATE CASCADE,
    FOREIGN KEY (StaffID_Issued) REFERENCES Staff(StaffID)
        ON DELETE SET NULL ON UPDATE CASCADE,
    CONSTRAINT chk_due_date CHECK (DueDate > IssueDate),
    CONSTRAINT chk_return_date CHECK (ReturnDate IS NULL OR ReturnDate >= IssueDate)
);

CREATE TABLE Reservation (
    ReservationID INT AUTO_INCREMENT PRIMARY KEY,
    BookID INT,
    MemberID INT,
    ReserveDate DATE DEFAULT CURRENT_DATE,
    Status ENUM('Pending','Ready','Collected','Expired') DEFAULT 'Pending',
    ExpiryDate DATE,
    FOREIGN KEY (BookID) REFERENCES Book(BookID)
        ON DELETE CASCADE ON UPDATE CASCADE,
    FOREIGN KEY (MemberID) REFERENCES Member(MemberID)
        ON DELETE CASCADE ON UPDATE CASCADE
);

CREATE TABLE Fine (
    FineID INT AUTO_INCREMENT PRIMARY KEY,
    MemberID INT,
    LoanID INT UNIQUE,
    Amount DECIMAL(10,2) NOT NULL,
    PaidDate DATE,
    Status ENUM('Paid','Unpaid') DEFAULT 'Unpaid',
    FOREIGN KEY (MemberID) REFERENCES Member(MemberID)
        ON DELETE RESTRICT ON UPDATE CASCADE,
    FOREIGN KEY (LoanID) REFERENCES Loan(LoanID)
        ON DELETE CASCADE ON UPDATE CASCADE
);